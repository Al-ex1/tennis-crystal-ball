<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="utf-8"/>
	<meta name="viewport" content="width=device-width, initial-scale=1"/>
	<title>Ultimate Tennis Statistics - Rankings Chart</title>
	<link th:href="@{/webjars/bootstrap/3.3.5/css/bootstrap.min.css}" rel="stylesheet" media="screen"/>
	<link th:href="@{/webjars/jquery-ui-themes/1.11.4/smoothness/jquery-ui.css}" rel="stylesheet" media="screen"/>
	<link th:href="@{/css/tennis-stats.css}" rel="stylesheet" media="screen"/>
	<script th:src="@{/webjars/jquery/2.1.4/jquery.min.js}"></script>
	<script th:src="@{/webjars/jquery-ui/1.11.4/jquery-ui.min.js}"></script>
	<script th:src="@{/js/rankingChart.js}"></script>
	<script type="text/javascript" src="https://www.google.com/jsapi"></script>
	<script type="text/javascript">
		/*<![CDATA[*/
		google.load("visualization", "1.0", {packages:["corechart"]});
		var isRank, chartData, logScale, legendPosition;
		function drawChart() {
			if ($.trim($("#players").val()).length > 0)
				doDrawChart($("#rankChartSize").slider("value"));
			else
				$("#rankChart").html("<div class='row'><div class='alert alert-warning col-md-9'>No player selected!</div></div>");
		}
		function doDrawChart(width) {
			var players = $("#players").val();
			var timeSpan = $("#timeSpan").val();
			var rankType = $("#rankType").val();
			isRank = rankType == "RANK";
			var dataUrl = "/playerRankingsTable?players=" + players + "&timeSpan=" + timeSpan + "&rankType=" + rankType;
			if (timeSpan == "CS") {
				var fromDate = getDate("fromDate");
				if (fromDate == null)
					return;
				var toDate = getDate("toDate");
				if (toDate == null)
					return;
				dataUrl += "&fromDate=" + fromDate + "&toDate=" + toDate;
			}
			if (timeSpan == "CR")
				dataUrl += "&byAge=" + $("#byAge").prop("checked");
			if (rankType == "POINTS")
				dataUrl += "&compensatePoints=" + $("#compensatePoints").prop("checked");
			var $loading = $("#loading");
			$loading.show();
			$.ajax(dataUrl).done(function(json) {
				chartData = new google.visualization.DataTable(JSON.stringify(json));
				logScale = isRank ? useLogScale(json) : false;
				legendPosition = json.cols.length < 5 ? "bottom" : "right";
				showChart(chartData, "rankChart", width, isRank, logScale, legendPosition);
				$loading.hide().css("position", "absolute").css("z-index", "100");
			});
		}
		function onTimeSpanChange() {
			var timeSpan = $("#timeSpan").val();
			$("#dateRange").css("display", timeSpan == "CS" ? "block" : "none");
			$("#byAgeDiv").css("display", timeSpan == "CR" ? "block" : "none");
		}
		function onRankTypeChange() {
			$("#compensatePointsDiv").css("visibility", $("#rankType").val() == "POINTS" ? "visible" : "hidden");
		}
		$(function() {
			function split(val) {
				return val.split(/,\s*/);
			}
			function extractLast(term) {
				return split(term).pop();
			}
			$("#players").bind("keydown", function(event) {
				if (event.keyCode === $.ui.keyCode.ENTER && !$(this).autocomplete("instance").menu.active)
				   drawChart();
				else if (event.keyCode === $.ui.keyCode.TAB && $(this).autocomplete("instance").menu.active)
					event.preventDefault();
			}).autocomplete({
				source: function(request, response) {
					$.getJSON("/autocompletePlayer", {
						term: extractLast(request.term)
					}, response);
				},
				search: function() {
					var term = extractLast(this.value);
					if (term.length < 2) {
						return false;
					}
				},
				focus: function() {
					return false;
				},
				select: function(event, ui) {
					var terms = split(this.value);
					terms.pop();
					terms.push(ui.item.value);
					terms.push("");
					this.value = terms.join(", ");
					return false;
				}
			});
			$("#fromDate").datepicker({
				defaultDate: "-1y", maxDate: "0", changeMonth: true, changeYear: true, showWeek: true, firstDay: 1, dateFormat: "dd-mm-yy",
				onClose: function(selectedDate) {
					$("#toDate").datepicker("option", "minDate", selectedDate);
				}
			});
			$("#toDate").datepicker({
				defaultDate: "0", maxDate: "0", changeMonth: true, changeYear: true, showWeek: true, firstDay: 1, dateFormat: "dd-mm-yy",
				onClose: function(selectedDate) {
					$("#fromDate").datepicker("option", "maxDate", selectedDate);
				}
			});
			$("div.ui-datepicker").css({fontSize: "12px"});
			$("#rankChartSize").slider({
				min: 500,
				max: 1500,
				value: 1000,
				step: 100,
				slide: function(event, ui) {
					showChart(chartData, "rankChart", ui.value, isRank, logScale, legendPosition);
				}
			});
			onTimeSpanChange();
			onRankTypeChange();
		});
		/*]]>*/
	</script>
	<style>
		.checkbox {
			margin-top: 7px;
			margin-bottom: 7px;
		}
	</style>
</head>
<body class="container">
	<div th:include="/fragments/header :: title"></div>
	<h3>Rankings Chart</h3>
	<div class="row">
		<div class="col-md-9">
			<div class="ui-widget input-group">
				<label for="players" class="input-group-addon">Players:</label>
				<input id="players" type="text" class="search-field form-control" placeholder="Search Players"/>
			</div>
		</div>
	</div>
	<div style="height: 5px"></div>
	<div class="row">
		<div class="col-md-3">
			<div class="input-group">
				<label for="timeSpan" class="input-group-addon">Time span:</label>
				<select id="timeSpan" class="form-control" onchange="onTimeSpanChange()">
					<option value="CR">Career</option>
					<option value="1">Last 52 weeks</option>
					<option value="2">Last two years</option>
					<option value="3">Last three years</option>
					<option value="5">Last five years</option>
					<option value="10">Last ten years</option>
					<option value="CS">Custom</option>
				</select>
			</div>
		</div>
		<div id="dateRange" class="col-md-4">
			<div class="input-group">
				<label for="fromDate" class="input-group-addon">From:</label>
				<input type="text" id="fromDate" maxlength="10" class="form-control"/>
				<label for="toDate" class="input-group-addon">To:</label>
				<input type="text" id="toDate" maxlength="10" class="form-control"/>
			</div>
		</div>
		<div class="col-md-2">
			<div id="byAgeDiv" class="checkbox">
				<label title="Show chart by age">
					<input id="byAge" type="checkbox"/> By age
				</label>
			</div>
		</div>
	</div>
	<div style="height: 5px"></div>
	<div class="row">
		<div class="col-md-3">
			<div class="input-group">
				<label for="rankType" class="input-group-addon">Rank type:</label>
				<select id="rankType" class="form-control" onchange="onRankTypeChange()">
					<option value="RANK">Ordinal rank</option>
					<option value="POINTS">Ranking points</option>
					<option value="GOAT_POINTS">GOAT points</option>
				</select>
			</div>
		</div>
		<div class="col-md-2">
			<div id="compensatePointsDiv" class="checkbox">
				<label title="Compensate ranking points before 2009 to match new ATP ranking system">
					<input id="compensatePoints" type="checkbox"/> Compensate points
				</label>
			</div>
		</div>
		<div class="col-md-2">
			<div id="rankChartSize" style="margin-top: 6px"></div>
			<div style="text-align: center; opacity: 0.5">Chart size</div>
		</div>
		<div class="col-md-2">
			<a class="btn btn-primary pull-right" href="#" role="button" onclick="drawChart()">
				<span class="glyphicon glyphicon-signal"></span>&nbsp;&nbsp;Draw Chart
			</a>
		</div>
	</div>
	<div class="row">
		<div class="row col-md-9 text-center">
			<div id="loading" style="width: 100%; display: none">
				<br/>
				<img src="/images/loading.gif" width="128" height="128" alt="Loading chart..."/>
				<br/>
			</div>
		</div>
	</div>
	<div id="rankChart"></div>
	<div th:include="/fragments/footer :: copy"></div>
</body>
</html>