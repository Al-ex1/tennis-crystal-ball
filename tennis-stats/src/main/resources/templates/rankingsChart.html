<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="utf-8"/>
	<meta name="viewport" content="width=device-width, initial-scale=1"/>
	<title>Ultimate Tennis Statistics - Rankings Chart</title>
	<link th:href="@{/webjars/bootstrap/3.3.5/css/bootstrap.min.css}" rel="stylesheet" media="screen"/>
	<link th:href="@{/webjars/jquery-ui-themes/1.11.4/smoothness/jquery-ui.css}" rel="stylesheet" media="screen"/>
	<link th:href="@{/css/tennis-stats.css}" rel="stylesheet" media="screen"/>
	<script th:src="@{/webjars/jquery/2.1.4/jquery.min.js}"></script>
	<script th:src="@{/webjars/jquery-ui/1.11.4/jquery-ui.min.js}"></script>
	<script type="text/javascript" src="https://www.google.com/jsapi"></script>
	<script type="text/javascript">
		/*<![CDATA[*/
		google.load("visualization", "1.0", {packages:["corechart"]});
		var chartData;
		var points;
		var logScale;
		function drawChart() {
			if ($.trim($("#players").val()).length > 0)
				doDrawChart(true, $("#rankChartSize").slider("value"));
			else
				$("#rankChart").html("<div class='row'><div class='alert alert-warning col-md-9'>No player selected!</div></div>");
		}
		function doDrawChart(fetchData, width) {
			var players = $("#players").val();
			var timeSpan = $("#timeSpan").val();
			points = $("#rankType").val() == "points";
			if (fetchData) {
				var dataUrl = "playerRankingsTable?players=" + players + "&timeSpan=" + timeSpan + "&points=" + points;
				if (timeSpan == "CS") {
					var fromDate = getDate("fromDate");
					if (fromDate == null)
						return;
					var toDate = getDate("toDate");
					if (toDate == null)
						return;
					dataUrl += "&fromDate=" + fromDate + "&toDate=" + toDate;
				}
				if (points)
					dataUrl += "&compensatePoints=" + $("#compensatePoints").prop("checked");
				var jsonData = $.ajax({
					url: dataUrl,
					dataType: "json",
					async: false
				}).responseText;
				var json = $.parseJSON(jsonData);
				switch (json.status) {
					case 400:
						alert(json.message);
						break;
					default:
						chartData = new google.visualization.DataTable(jsonData);
						logScale = useLogScale(json);
						break;
				}
			}
			if (chartData != undefined) {
				var options = {
					width: width,
					height: width / 2,
					chartArea: {left: 50, top: 20, height: "80%"},
					vAxis: {direction: points ? 1 : -1, viewWindow: {min: points ? undefined : 1}, logScale: points ? false : logScale}
				};
				var chart = new google.visualization.LineChart(document.getElementById("rankChart"));
				chart.draw(chartData, options);
			}
		}
		function useLogScale(json) {
			var min = Number.MAX_VALUE;
			var max = 0;
			for (var i = 0, ilen = json.rows.length; i < ilen; i++) {
				var row = json.rows[i];
				for (var j = 0, jlen = row.c.length; j < jlen; j++) {
					if (j > 0) {
						var value = row.c[j].v;
						min = Math.min(min, value);
						max = Math.max(max, value);
					}
				}
			}
			return max - min >= 50;
		}
		function onTimeSpanChange() {
			$("#dateRange").css("visibility", $("#timeSpan").val() == "CS" ? "visible" : "hidden");
		}
		function onRankTypeChange() {
			$("#compensatePoints").prop("disabled", $("#rankType").val() == "rank");
		}
		function getDate(id) {
			var $date = $("#" + id);
			var date = $date.val();
			if (date == "")
				return date;
			try {
				$.datepicker.parseDate("dd-mm-yy", date);
				return date;
			}
			catch (err) {
				alert("Invalid " + id.substr(0, id.length - 4) + " date: " + date);
				$date.focus();
				return null;
			}
		}
		$(function() {
			function split(val) {
				return val.split(/,\s*/);
			}
			function extractLast(term) {
				return split(term).pop();
			}
			$("#players").bind("keydown", function(event) {
				if (event.keyCode === $.ui.keyCode.ENTER && !$(this).autocomplete("instance").menu.active)
				   drawChart();
				else if (event.keyCode === $.ui.keyCode.TAB && $(this).autocomplete("instance").menu.active)
					event.preventDefault();
			}).autocomplete({
				source: function(request, response) {
					$.getJSON("autocompletePlayer", {
						term: extractLast(request.term)
					}, response);
				},
				search: function() {
					var term = extractLast(this.value);
					if (term.length < 2) {
						return false;
					}
				},
				focus: function() {
					return false;
				},
				select: function(event, ui) {
					var terms = split(this.value);
					terms.pop();
					terms.push(ui.item.value);
					terms.push("");
					this.value = terms.join(", ");
					return false;
				}
			});
			$("#fromDate").datepicker({
				defaultDate: "-1y", maxDate: "0", changeMonth: true, changeYear: true, showWeek: true, firstDay: 1, dateFormat: "dd-mm-yy",
				onClose: function(selectedDate) {
					$("#toDate").datepicker("option", "minDate", selectedDate);
				}
			});
			$("#toDate").datepicker({
				defaultDate: "0", maxDate: "0", changeMonth: true, changeYear: true, showWeek: true, firstDay: 1, dateFormat: "dd-mm-yy",
				onClose: function(selectedDate) {
					$("#fromDate").datepicker("option", "maxDate", selectedDate);
				}
			});
			$("div.ui-datepicker").css({ fontSize: "12px" });
			$("#rankChartSize").slider({
				min: 500,
				max: 1500,
				value: 1000,
				step: 100,
				slide: function(event, ui) {
					doDrawChart(false, ui.value);
				}
			});
			onTimeSpanChange();
			onRankTypeChange();
		});
		/*]]>*/
	</script>
</head>
<body class="container">
	<div th:include="fragments/header :: title"></div>
	<h3>Rankings Chart</h3>
	<div class="row">
		<div class="col-md-9">
			<div class="ui-widget input-group">
				<label for="players" class="input-group-addon">Players:</label>
				<input id="players" type="text" class="search-field form-control" placeholder="Search Players"/>
			</div>
		</div>
	</div>
	<div style="height: 4px"></div>
	<div class="row">
		<div class="col-md-3">
			<div class="input-group">
				<label for="timeSpan" class="input-group-addon">Time span:</label>
				<select id="timeSpan" class="form-control" onchange="onTimeSpanChange()">
					<option value="CR">Career</option>
					<option value="1">Last 52 weeks</option>
					<option value="2">Last two years</option>
					<option value="3">Last three years</option>
					<option value="5">Last five years</option>
					<option value="10">Last ten years</option>
					<option value="CS">Custom</option>
				</select>
			</div>
		</div>
		<div id="dateRange" class="col-md-4">
			<div class="input-group">
				<label for="fromDate" class="input-group-addon">From:</label>
				<input type="text" id="fromDate" maxlength="10" class="form-control"/>
				<label for="toDate" class="input-group-addon">To:</label>
				<input type="text" id="toDate" maxlength="10" class="form-control"/>
			</div>
		</div>
	</div>
	<div style="height: 4px"></div>
	<div class="row">
		<div class="col-md-3">
			<div class="input-group">
				<label for="rankType" class="input-group-addon">Rank type:</label>
				<select id="rankType" class="form-control" onchange="onRankTypeChange()">
					<option value="rank">Ordinal rank</option>
					<option value="points">Ranking points</option>
				</select>
			</div>
		</div>
		<div class="col-md-2">
			<div class="checkbox">
				<label title="Compensate ranking points before 2009 to match new ATP ranking system">
					<input id="compensatePoints" type="checkbox"/> Compensate points
				</label>
			</div>
		</div>
		<div class="col-md-2">
			<div id="rankChartSize" style="margin-top: 6px"></div>
			<div style="text-align: center; opacity: 0.5">Chart size</div>
		</div>
		<div class="col-md-2">
			<a class="btn btn-primary pull-right" href="#" role="button" onclick="drawChart()">
				<span class="glyphicon glyphicon-signal"></span>&nbsp;&nbsp;Draw Chart
			</a>
		</div>
	</div>
	<div id="rankChart"></div>
	<div th:include="fragments/footer :: copy"></div>
</body>
</html>